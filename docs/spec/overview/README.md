# 全体的な仕様

## 未定義部分

- 利用規約的な
  - アカウント削除時のデータの扱い
- シーケンス
  - 管理者の招待
- フィーバーの仕様
- 画像のクラスタリングの方法
- 画像サーバーの pub/sub の仕様

## 仕様

### モバイルの要件

イベント参加者とイベント運営が使用するアプリ。
Flutter で iOS/Android 向けに作成する。

#### イベント参加者向け

- イベント参加 QR スキャン
  URL からパラメータのイベント ID のみを解釈し、サーバーに送信する。
  内部的にこのタイミングでアカウントが作成される。
  [イベント参加 QR コードの仕様](../system/data.md#LP/イベント参加兼用コード)
- スポット検知
  ServiceUUID でビーコンを購読して、スポットに入った、出たことを LINE Simple Beacon を使い検出し、サーバーに送信する。
- ピック用 QR スキャン
  JSON の QR コードを読み込み、サーバーに送信する。
  [ピックスポットのパレット取得 QR コードの仕様](../system/data.md#ピックスポットのパレット取得コード)
- 画像を表示
  現在の収集状況に応じて、画像を表示する。
  画像はアプリ使用者の意思によって任意のタイミングで保存できる。
  デフォルト画像(複数枚)と撮影した画像(0..1)を選択することができる。
- 参加者 QR 表示
  参加者識別 QR を表示する。
  **すでに写真が登録されていた場合は、上書きすると元の撮影写真が消える旨の説明を行う。**
  [参加者識別 QR コードの仕様](../system/data.md#参加者識別コード)
- HP などへの導線
  イベント HP や、イベント運営の連絡先などを表示する。
- 通知
  二つのタイミングで通知を行う。
  - ピック可能なスポットに入ったとき
  - 現在いるスポットから他のスポットへの人流制御が行われたとき
- アカウントの削除
  任意のタイミングでアカウントを削除できるようにする。
  削除をすると、バッチ処理により event_log に定義されるデータ以の全てのデータが破棄されることが保証される。

#### イベント運営向け

- Auth0 によるログイン
  コンソールと同様のアカウントでログインする必要がある。
- 写真撮影
  参加者の QR コードを読み込み、参加者の写真を撮影し、サーバーに送信する。
  複数人の写真を同時に撮影ができ、その場合は参加者の QR を連続して読み取る。
  [参加者識別 QR コードの仕様](../system/data.md#参加者識別コード)
- ビーコン・スポットの登録
  ビーコンの HWID とスポットの ID を紐付ける。
  登録時にスポットの登録名を入力する。
- スポットの確認
  近くにあるスポットを確認する。
  電波強度により、どのビーコンをどのスポットとして登録したかを確認できる。

### イベント運営向け Web コンソールの要件

イベント運営が使用するアプリ。
Node.js で Web アプリとして作成する。

#### イベント前

- イベントの作成・設定
  イベントを作成し、設定する。
  [イベントデータ](../system/data.md#イベントデータ)
  イベント参加者が参加するための QR コードが生成される。
  [LP/イベント参加兼用コード](../system/data.md#LP/イベント参加兼用コード)
- イベント管理者の招待
  イベント管理者を既存のイベントに招待する。
  招待 URL メールアドレス宛に送り、Auth0 のアカウントをイベントに関連付ける。
- ピックスポットの設定
  登録してあるスポットに対して、ピックスポットとして設定する。
  ピックスポットの QR コードが生成される。
  [ピックスポットのパレット取得 QR コードの仕様](../system/data.md#ピックスポットのパレット取得コード)

#### イベント中

- 人流制御
  あるスポットから別のスポットへの人流制御を行う。
  あるスポットにいるランダムな参加者に通知が行く。
  人流制御先のスポットはフィーバーとなり、パレットが増加する。
  > 終了タイミングは、B にいる人間が A の n%になるまで、または増加イベントの時間制限がくるまで

#### イベント中・イベント後

- イベントのメトリクスの可視化
  イベントログを Grafana で可視化する。
  [イベントログ](../system/data.md#イベントログ)

### バックエンドの要件

API サーバーは Rust で作成する。
そのほかは後述する。

#### バックエンド API サーバー

各要件を満たすような API を提供する。
[API スキーマのリポジトリ](https://github.com/after-school-garbage-squad/repaint-schema)

#### 画像処理

Pub/Sub により、バックエンド API サーバーから画像処理のリクエストを受け取り、画像処理を行う。

- 画像のクラスタリング
  画像の色をパレットに分けて、パレット別の透過 png を生成する。
- 画像の合成
  リクエストをもとにパレットの透過 png を合成する。

#### 画像取得ワンタイム認証サーバー

[repaint-image-otp のリポジトリ](https://github.com/after-school-garbage-squad/repaint-image-otp)

Nginx と連携し、通常の URL をワンタイム URL にする。

画像取得 URL が、`https://example.com/image/1234567890`の場合、`https://example.com/image/1234567890?token=abcdefg`のように、`token`パラメータを付与する。
